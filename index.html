<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Scholar: DOI Link Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 text-white p-1.5 rounded">
                    <i class="fa-solid fa-bolt"></i>
                </div>
            </div>
            <div class="text-xs text-slate-400 font-mono">v3.3 Link Mode</div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 max-w-6xl mx-auto w-full gap-6 flex flex-col md:flex-row">
        
        <!-- Input Panel -->
        <div class="w-full md:w-1/3 space-y-4">
            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email (API Requirement)</label>
                        <input type="email" id="userEmail" placeholder="Auto-generated if empty..." class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">DOIs (One per line)</label>
                        <textarea id="doiInput" rows="10" class="w-full px-3 py-2 border border-slate-300 rounded font-mono text-xs focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="10.1371/journal.pcbi.1004668&#10;10.1038/nature12345"></textarea>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="startProcessing()" id="startBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-semibold transition-colors shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-search"></i> Find Links
                        </button>
                        <button onclick="stopProcessing()" id="stopBtn" class="hidden flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded font-semibold transition-colors shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-stop"></i> Stop
                        </button>
                        <button onclick="clearAll()" class="px-3 py-2 border border-slate-300 rounded text-slate-600 hover:bg-slate-50">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    
                    <!-- Sci-Hub Toggle -->
                    <div class="flex items-center justify-between pt-3 border-t border-slate-200 mt-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-500 uppercase">Sci-Hub for Non-OA</span>
                            <span class="text-[10px] text-slate-400" title="When enabled, shows Sci-Hub links for papers without open access. When disabled, shows regular DOI links.">
                                <i class="fa-solid fa-circle-info"></i>
                            </span>
                        </div>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" id="scihubToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 border-slate-300 appearance-none cursor-pointer transition-all duration-200" />
                            <label for="scihubToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-200"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simple Stats -->
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-white p-3 rounded border border-slate-200 text-center">
                    <div class="text-[10px] uppercase font-bold text-slate-400">Open Access</div>
                    <div id="successCount" class="text-xl font-bold text-emerald-600">0</div>
                </div>
                <div class="bg-white p-3 rounded border border-slate-200 text-center">
                    <div class="text-[10px] uppercase font-bold text-slate-400">Non-OA / Failed</div>
                    <div id="failedCount" class="text-xl font-bold text-amber-500">0</div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="w-full md:w-2/3 flex flex-col h-[600px] bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h2 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-list-ul mr-2 text-slate-400"></i>Queue</h2>
                <span id="statusText" class="text-xs text-slate-500 font-mono">Waiting...</span>
            </div>
            <div class="flex-grow overflow-auto scrollbar-thin relative">
                <table class="w-full text-left border-collapse">
                    <tbody id="resultsBody" class="text-sm divide-y divide-slate-100">
                        <tr>
                            <td class="p-8 text-center text-slate-400 italic">
                                Add DOIs and click "Find Links".<br>Links will appear for manual download.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Progress Bar (Bottom) -->
            <div class="h-1.5 bg-slate-100 w-full">
                <div id="progressBar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration ---
        const PROXIES = [
            "https://api.codetabs.com/v1/proxy?quest=",
            "https://corsproxy.io/?",
            "https://thingproxy.freeboard.io/fetch/"
        ];
        const SCIHUB_BASE = "https://sci-hub.se/";

        // --- State ---
        let queue = [];
        let isRunning = false;
        let processedCount = 0;

        // --- Utils ---
        const wait = (ms) => new Promise(r => setTimeout(r, ms));
        const cleanDOI = (s) => s.trim().replace(/^https?:\/\/doi\.org\//i, '').replace(/^doi:/i, '');
        const generateEmail = () => `guest_${Math.random().toString(36).slice(2,8)}@gmail.com`;

        // --- Main Process ---
        async function startProcessing() {
            const input = document.getElementById('doiInput').value;
            let email = document.getElementById('userEmail').value;
            
            if (!email) {
                email = generateEmail();
                document.getElementById('userEmail').value = email;
            }

            const lines = input.split('\n').map(cleanDOI).filter(d => d.length > 4);
            if (lines.length === 0) return alert("No DOIs found");

            // Reset State
            queue = lines.map((doi, i) => ({ id: i+1, doi, status: 'pending', title: '...' }));
            processedCount = 0;
            document.getElementById('successCount').textContent = '0';
            document.getElementById('failedCount').textContent = '0';
            document.getElementById('resultsBody').innerHTML = '';
            
            // UI Update
            renderList();
            toggleRunning(true);

            // Process Loop
            for (let i = 0; i < queue.length; i++) {
                if (!isRunning) break;
                await processOne(queue[i], email, lines.length);
            }

            toggleRunning(false);
            document.getElementById('statusText').textContent = "Process Complete";
        }

        function stopProcessing() {
            isRunning = false;
            document.getElementById('statusText').textContent = "Stopping...";
        }

        async function processOne(item, email, total) {
            updateRowUI(item.id, "Fetching Metadata...", "text-blue-500 animate-pulse-fast");
            
            let pdfUrl = null;
            let title = item.doi;
            let isOpenAccess = false; // Track OA status from APIs
            const useScihub = document.getElementById('scihubToggle').checked;

            try {
                // 1. Metadata (OpenAlex)
                const metaUrl = `https://api.openalex.org/works/https://doi.org/${item.doi}?mailto=${email}`;
                const metaRes = await fetch(metaUrl).catch(() => null);
                
                if (metaRes && metaRes.ok) {
                    const data = await metaRes.json();
                    title = data.title || title;
                    
                    // Check OA status from OpenAlex
                    if (data.open_access?.is_oa) {
                        isOpenAccess = true;
                    }
                    
                    // Direct Link?
                    pdfUrl = data.open_access?.oa_url || data.best_oa_location?.pdf_url;
                    
                    // Update Title UI
                    const titleEl = document.getElementById(`title-${item.id}`);
                    if(titleEl) titleEl.innerText = title;
                }

                // 2. Unpaywall (Secondary Check)
                if (!pdfUrl) {
                    try {
                        const upwUrl = `https://api.unpaywall.org/v2/${item.doi}?email=${email}`;
                        const upwRes = await fetch(upwUrl).catch(() => null);
                        if (upwRes && upwRes.ok) {
                            const upwData = await upwRes.json();
                            // Update title if OpenAlex failed completely
                            if (title === item.doi && upwData.title) {
                                title = upwData.title;
                                const titleEl = document.getElementById(`title-${item.id}`);
                                if(titleEl) titleEl.innerText = title;
                            }
                            
                            // Check OA status from Unpaywall
                            if (upwData.is_oa) {
                                isOpenAccess = true;
                            }
                            
                            if (upwData.best_oa_location && upwData.best_oa_location.url_for_pdf) {
                                pdfUrl = upwData.best_oa_location.url_for_pdf;
                            }
                        }
                    } catch (e) { /* Ignore Unpaywall errors */ }
                }

                // 3. Deep Scan (Automatic if no link)
                if (!pdfUrl) {
                    updateRowUI(item.id, "Scanning Publisher...", "text-purple-500");
                    pdfUrl = await deepScan(item.doi);
                }

                // 4. Show Link - Handle different scenarios
                const statusEl = document.getElementById(`status-${item.id}`);
                const doiLink = `https://doi.org/${item.doi}`;
                
                if (pdfUrl && isOpenAccess) {
                    // Case: Open Access - Direct PDF link available
                    statusEl.innerHTML = `<a href="${pdfUrl}" target="_blank" class="text-emerald-600 hover:text-emerald-800 hover:underline font-bold flex items-center justify-end gap-1"><span class="bg-emerald-100 text-emerald-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Open Access</span><i class="fa-solid fa-download"></i> PDF</a>`;
                    document.getElementById('successCount').textContent = parseInt(document.getElementById('successCount').textContent) + 1;
                } else if (pdfUrl && !isOpenAccess) {
                    // Case: Found PDF from deep scan but not confirmed OA
                    statusEl.innerHTML = `<a href="${pdfUrl}" target="_blank" class="text-emerald-600 hover:text-emerald-800 hover:underline font-bold flex items-center justify-end gap-1"><span class="bg-emerald-100 text-emerald-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Open Access</span><i class="fa-solid fa-download"></i> PDF</a>`;
                    document.getElementById('successCount').textContent = parseInt(document.getElementById('successCount').textContent) + 1;
                } else if (!pdfUrl && title !== item.doi) {
                    // Case: Non-OA - We have metadata but no direct PDF
                    document.getElementById('failedCount').textContent = parseInt(document.getElementById('failedCount').textContent) + 1;
                    
                    if (useScihub) {
                        // Sci-Hub ON: Check Sci-Hub for PDF availability
                        updateRowUI(item.id, "Checking Sci-Hub...", "text-amber-500 animate-pulse-fast");
                        const scihubPdfUrl = await checkScihub(item.doi);
                        
                        if (scihubPdfUrl) {
                            // Sci-Hub has the PDF
                            statusEl.innerHTML = `<a href="${scihubPdfUrl}" target="_blank" class="text-amber-600 hover:text-amber-800 hover:underline font-bold flex items-center justify-end gap-1"><span class="bg-amber-100 text-amber-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Sci-Hub</span><i class="fa-solid fa-unlock"></i> PDF</a>`;
                        } else {
                            // Sci-Hub doesn't have it, fall back to journal link
                            statusEl.innerHTML = `<a href="${doiLink}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline flex items-center justify-end gap-1"><span class="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Journal</span><i class="fa-solid fa-external-link"></i></a>`;
                        }
                    } else {
                        // Sci-Hub OFF: Show DOI link to journal page
                        statusEl.innerHTML = `<a href="${doiLink}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline flex items-center justify-end gap-1"><span class="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Journal</span><i class="fa-solid fa-external-link"></i></a>`;
                    }
                } else {
                    // Case: No valid link found - couldn't get metadata or DOI is invalid
                    document.getElementById('failedCount').textContent = parseInt(document.getElementById('failedCount').textContent) + 1;
                    
                    if (useScihub) {
                        // Still try Sci-Hub as last resort
                        updateRowUI(item.id, "Trying Sci-Hub...", "text-amber-500 animate-pulse-fast");
                        const scihubPdfUrl = await checkScihub(item.doi);
                        
                        if (scihubPdfUrl) {
                            statusEl.innerHTML = `<a href="${scihubPdfUrl}" target="_blank" class="text-amber-600 hover:text-amber-800 hover:underline font-bold flex items-center justify-end gap-1"><span class="bg-amber-100 text-amber-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Sci-Hub</span><i class="fa-solid fa-unlock"></i> PDF</a>`;
                        } else {
                            statusEl.innerHTML = `<span class="text-red-400 flex items-center justify-end gap-1"><i class="fa-solid fa-circle-xmark text-[10px]"></i> <span class="text-xs">No Link Found</span></span>`;
                        }
                    } else {
                        statusEl.innerHTML = `<span class="text-red-400 flex items-center justify-end gap-1"><i class="fa-solid fa-circle-xmark text-[10px]"></i> <span class="text-xs">No Link Found</span></span>`;
                    }
                }

            } catch (err) {
                console.warn(err);
                document.getElementById('failedCount').textContent = parseInt(document.getElementById('failedCount').textContent) + 1;
                
                const statusEl = document.getElementById(`status-${item.id}`);
                const doiLink = `https://doi.org/${item.doi}`;
                
                // Error occurred - still try to provide something useful
                if (useScihub) {
                    // Sci-Hub ON: Try Sci-Hub as fallback
                    updateRowUI(item.id, "Trying Sci-Hub...", "text-amber-500 animate-pulse-fast");
                    const scihubPdfUrl = await checkScihub(item.doi);
                    
                    if (scihubPdfUrl) {
                        statusEl.innerHTML = `<a href="${scihubPdfUrl}" target="_blank" class="text-amber-600 hover:text-amber-800 hover:underline font-bold flex items-center justify-end gap-1"><span class="bg-amber-100 text-amber-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Sci-Hub</span><i class="fa-solid fa-unlock"></i> PDF</a>`;
                    } else {
                        // Sci-Hub doesn't have it, fall back to journal link
                        statusEl.innerHTML = `<a href="${doiLink}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline flex items-center justify-end gap-1"><span class="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Journal</span><i class="fa-solid fa-external-link"></i></a>`;
                    }
                } else {
                    // Sci-Hub OFF: Show DOI link to journal page as fallback
                    statusEl.innerHTML = `<a href="${doiLink}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline flex items-center justify-end gap-1"><span class="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 rounded mr-1">Journal</span><i class="fa-solid fa-external-link"></i></a>`;
                }
            }

            // Progress Bar
            processedCount++;
            const pct = (processedCount / total) * 100;
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('statusText').textContent = `Processing ${processedCount}/${total}`;
        }

        // --- Scraper Logic ---
        // Sci-Hub mirrors to try
        const SCIHUB_MIRRORS = [
            "https://sci-hub.se/",
            "https://sci-hub.st/",
            "https://sci-hub.ru/"
        ];
        
        // Check Sci-Hub for PDF availability and return direct PDF link if found
        async function checkScihub(doi) {
            for (const mirror of SCIHUB_MIRRORS) {
                const scihubUrl = mirror + doi;
                for (const proxy of PROXIES) {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(scihubUrl), { credentials: 'omit' });
                        if (!res.ok) continue;
                        const html = await res.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // Look for the PDF embed or download button in Sci-Hub page
                        // Sci-Hub uses an embed with id="pdf" or an iframe
                        const embed = doc.querySelector('embed#pdf');
                        if (embed && embed.getAttribute('src')) {
                            let pdfSrc = embed.getAttribute('src');
                            // Handle relative URLs
                            if (pdfSrc.startsWith('//')) {
                                pdfSrc = 'https:' + pdfSrc;
                            } else if (pdfSrc.startsWith('/')) {
                                pdfSrc = mirror.replace(/\/$/, '') + pdfSrc;
                            }
                            return pdfSrc;
                        }
                        
                        // Alternative: Look for iframe with PDF
                        const iframe = doc.querySelector('iframe#pdf');
                        if (iframe && iframe.getAttribute('src')) {
                            let pdfSrc = iframe.getAttribute('src');
                            if (pdfSrc.startsWith('//')) {
                                pdfSrc = 'https:' + pdfSrc;
                            } else if (pdfSrc.startsWith('/')) {
                                pdfSrc = mirror.replace(/\/$/, '') + pdfSrc;
                            }
                            return pdfSrc;
                        }
                        
                        // Alternative: Look for any PDF link
                        const links = doc.querySelectorAll('a[href*=".pdf"], button[onclick*=".pdf"]');
                        for (const link of links) {
                            let href = link.getAttribute('href') || '';
                            if (href.includes('.pdf')) {
                                if (href.startsWith('//')) {
                                    href = 'https:' + href;
                                } else if (href.startsWith('/')) {
                                    href = mirror.replace(/\/$/, '') + href;
                                }
                                return href;
                            }
                        }
                        
                        // Check if page contains "article not found" message
                        const bodyText = doc.body?.textContent?.toLowerCase() || '';
                        if (bodyText.includes('article not found') || bodyText.includes('не найдена')) {
                            return null; // Sci-Hub doesn't have this paper
                        }
                        
                    } catch (e) { continue; }
                }
            }
            return null; // Sci-Hub doesn't have this paper or couldn't be reached
        }

        async function deepScan(doi) {
            const target = `https://doi.org/${doi}`;
            
            for (const proxy of PROXIES) {
                try {
                    const res = await fetch(proxy + encodeURIComponent(target), { credentials: 'omit' });
                    if (!res.ok) continue;
                    const html = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Strategy A: Meta Tags
                    const meta = doc.querySelector('meta[name="citation_pdf_url"]');
                    if (meta && meta.content) return meta.content;

                    // Strategy B: Base URL + Relative Links
                    let baseUrl = "";
                    try { 
                        // Attempt to find original domain from canonical or OG
                        const og = doc.querySelector('meta[property="og:url"]');
                        if(og) baseUrl = new URL(og.content).origin;
                    } catch(e){}

                    // Strategy C: Link Hunting
                    const links = Array.from(doc.querySelectorAll('a'));
                    for (const a of links) {
                        let href = a.getAttribute('href');
                        if (!href) continue;
                        
                        // Fix relative links
                        if (href.startsWith('/') && baseUrl) href = baseUrl + href;
                        // If we still don't have a base URL, relative links are useless here
                        if (!href.startsWith('http')) continue;

                        const lower = href.toLowerCase();
                        // OUP specific or generic PDF
                        if (lower.includes('/article-pdf/') || lower.endsWith('.pdf')) {
                            return href;
                        }
                    }
                } catch (e) { continue; }
            }
            return null;
        }

        // --- UI Functions ---
        function renderList() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = queue.map(item => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="p-3 w-10 text-slate-300 text-xs font-mono">${item.id}</td>
                    <td class="p-3">
                        <div id="title-${item.id}" class="text-xs font-bold text-slate-700 mb-1 truncate w-[300px] md:w-[400px]">${item.doi}</div>
                        <div class="text-[10px] text-slate-400 font-mono">${item.doi}</div>
                    </td>
                    <td class="p-3 w-36 text-right">
                        <span id="status-${item.id}" class="text-xs font-bold text-slate-400">Pending</span>
                    </td>
                </tr>
            `).join('');
        }

        function updateRowUI(id, text, classes) {
            const el = document.getElementById(`status-${id}`);
            if (el) {
                el.textContent = text;
                el.className = `text-xs font-bold ${classes}`;
            }
        }

        function toggleRunning(active) {
            isRunning = active;
            const start = document.getElementById('startBtn');
            const stop = document.getElementById('stopBtn');
            if (active) {
                start.classList.add('hidden');
                stop.classList.remove('hidden');
                document.getElementById('doiInput').disabled = true;
                document.getElementById('scihubToggle').disabled = true;
            } else {
                start.classList.remove('hidden');
                stop.classList.add('hidden');
                document.getElementById('doiInput').disabled = false;
                document.getElementById('scihubToggle').disabled = false;
            }
        }

        function clearAll() {
            if(confirm("Clear everything?")) {
                document.getElementById('doiInput').value = '';
                document.getElementById('resultsBody').innerHTML = '';
                document.getElementById('successCount').textContent = '0';
                document.getElementById('failedCount').textContent = '0';
                document.getElementById('progressBar').style.width = '0%';
            }
        }
    </script>
</body>
</html>